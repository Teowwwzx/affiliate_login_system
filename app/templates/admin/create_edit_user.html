{% extends "new_base.html" %}

{% block title %}{{ title if title else "Manage User" }}{% endblock %}

{% block page_header %}
<h1>{{ title }}</h1>
<p>Welcome, Admin! Here's an overview of your users.</p>
{% endblock %}

{% block page_content %}
<div class="container-fluid mt-4">

    <!-- Flash Messages -->
    <div class="mb-3">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}
    </div>


    {% set form_action = action_url if action_url else url_for('admin.create_user') %}
    {% set is_edit_mode = True if user else False %}

    <form method="POST" action="{{ form_action }}" class="mt-5">
        {{ csrf_token if csrf_token }}

        <div class="mb-3">
            <label for="username" class="form-label">Username <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="username" name="username"
                value="{{ user_data.username if user_data else (user.username if is_edit_mode else '') }}" required {%
                if is_edit_mode and user.role=='admin' %}disabled{% endif %}>
        </div>

        <div class="mb-3">
            <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
            <div class="input-group">
                <input type="text" class="form-control" id="email_username" name="email_username"
                    value="{{ user_data.email.split('@')[0] if user_data and '@' in user_data.email else (user.email.split('@')[0] if is_edit_mode and user.email and '@' in user_data.email else '') }}"
                    {% if is_edit_mode and user.role=='admin' %}disabled{% endif %}>
                <span class="input-group-text">@</span>
                <select class="form-select" id="email_domain" name="email_domain" style="max-width: 150px;" {% if
                    is_edit_mode and user.role=='admin' %}disabled{% endif %}>
                    <option value="gmail.com" {% if (user_data and '@' in user_data.email and
                        user_data.email.split('@')[1]=='gmail.com' ) or (is_edit_mode and user.email and '@' in
                        user.email and user.email.split('@')[1]=='gmail.com' ) %}selected{% endif %}>gmail.com</option>
                    <option value="yahoo.com" {% if (user_data and '@' in user_data.email and
                        user_data.email.split('@')[1]=='yahoo.com' ) or (is_edit_mode and user.email and '@' in
                        user.email and user.email.split('@')[1]=='yahoo.com' ) %}selected{% endif %}>yahoo.com</option>
                    <option value="outlook.com" {% if (user_data and '@' in user_data.email and
                        user_data.email.split('@')[1]=='outlook.com' ) or (is_edit_mode and user.email and '@' in
                        user.email and user.email.split('@')[1]=='outlook.com' ) %}selected{% endif %}>outlook.com
                    </option>
                    <option value="hotmail.com" {% if (user_data and '@' in user_data.email and
                        user_data.email.split('@')[1]=='hotmail.com' ) or (is_edit_mode and user.email and '@' in
                        user.email and user.email.split('@')[1]=='hotmail.com' ) %}selected{% endif %}>hotmail.com
                    </option>
                    <option value="">Custom domain...</option>
                </select>
                <input type="text" class="form-control" id="custom_domain" name="custom_domain" style="display: none;"
                    placeholder="Enter domain"
                    value="{{ user_data.email.split('@')[1] if user_data and '@' in user_data.email and user_data.email.split('@')[1] not in ['gmail.com', 'yahoo.com', 'outlook.com', 'hotmail.com'] else (user.email.split('@')[1] if is_edit_mode and user.email and '@' in user.email and user.email.split('@')[1] not in ['gmail.com', 'yahoo.com', 'outlook.com', 'hotmail.com'] else '') }}"
                    {% if is_edit_mode and user.role=='admin' %}disabled{% endif %}>
                <input type="hidden" id="email" name="email"
                    value="{{ user_data.email if user_data else (user.email if is_edit_mode else '') }}" required>
            </div>
            <div id="email-preview" class="form-text text-muted">
                {% if user_data and user_data.email %}
                {{ user_data.email }}
                {% elif is_edit_mode and user.email %}
                {{ user.email }}
                {% else %}
                Enter username and select domain
                {% endif %}
            </div>
        </div>

        {% if not is_edit_mode %} {# Only show password for new user creation #}
        <div class="mb-3">
            <label for="password" class="form-label">Password <span class="text-danger">*</span></label>
            <input type="password" class="form-control" id="password" name="password" required>
        </div>
        {% else %}
        <div class="mb-3">
            <p class="form-text text-muted">Password can be reset via a separate "Reset Password" action (to be
                implemented).</p>
        </div>
        {% endif %}

        <div class="mb-3">
            <label for="role" class="form-label">Role <span class="text-danger">*</span></label>
            <select class="form-select" id="role" name="role" required {% if is_edit_mode and user.role=='admin'
                %}disabled{% endif %}>
                {% set current_role = user_data.role if user_data else (user.role if is_edit_mode else '') %}
                <option value="member" {% if current_role=='member' %}selected{% endif %}>Member</option>
                <option value="leader" {% if current_role=='leader' %}selected{% endif %}>Leader</option>
                {% if not is_edit_mode or (is_edit_mode and current_role == 'admin') %}
                {# Allow 'admin' option only if editing an existing admin (field will be disabled), or if some logic
                allowed creating admins this way #}
                {# For safety, if creating, we might want to remove admin option completely if only one admin is allowed
                from seed #}
                {% if is_edit_mode and current_role == 'admin'%}
                <option value="admin" {% if current_role=='admin' %}selected{% endif %}>Admin</option>
                {% elif not is_edit_mode %}
                {# Do not show Admin option when creating a new user via the form #}
                {% endif %}
                {% endif %}
            </select>
            {% if is_edit_mode and user.role == 'admin' %}
            <input type="hidden" name="role" value="admin"> {# Submit the admin role if disabled #}
            {% endif %}
        </div>

        <div class="mb-3" id="leaderSelection" style="display: none;">
            <label for="leader_id" class="form-label">Assign to Leader <span id="leaderRequiredAsterisk"
                    class="text-danger" style="display: none;">*</span></label>
            <select class="form-select" id="leader_id" name="leader_id" {% if is_edit_mode and user.role=='admin'
                %}disabled{% endif %}>
                <option value="">-- Select Leader --</option>
                {% set current_leader_id = user_data.leader_id if user_data else (user.leader_id if is_edit_mode and
                user.leader_id else '') %}
                {% for leader_user in leaders %} {# Changed variable name from leader to leader_user to avoid conflict
                with user.leader #}
                <option value="{{ leader_user.id }}" {% if leader_user.id|string==current_leader_id|string %}selected{%
                    endif %}>{{ leader_user.username }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3 form-check">
            {% set current_status = user_data.status if user_data and 'status' in user_data else (user.status if
            is_edit_mode else True) %}
            <input type="checkbox" class="form-check-input" id="status" name="status" value="true" {% if current_status
                %}checked{% endif %} {% if is_edit_mode and user.role=='admin' %}disabled{% endif %}>
            <label class="form-check-label" for="status">Active</label>
        </div>

        {% if not (is_edit_mode and user.role == 'admin') %} {# Hide buttons if editing an admin #}
        <button type="submit" class="btn btn-primary">{{ 'Update' if is_edit_mode else 'Create' }} User</button>
        {% endif %}
        <a href="{{ url_for('admin.list_users') }}" class="btn btn-secondary">Cancel</a>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const roleSelect = document.getElementById('role');
        const leaderSelectionDiv = document.getElementById('leaderSelection');
        const leaderRequiredAsterisk = document.getElementById('leaderRequiredAsterisk');
        const isEditMode = {{ is_edit_mode| tojson
    }}; // Pass boolean to JS
    const currentUserRole = "{{ user.role if user else '' }}";
    const emailUsername = document.getElementById('email_username');
    const emailDomain = document.getElementById('email_domain');
    const customDomain = document.getElementById('custom_domain');
    const emailHidden = document.getElementById('email');
    const emailPreview = document.getElementById('email-preview');

    // Function to toggle leader selection visibility
    function toggleLeaderSelection() {
        if (roleSelect.value === 'member' && !(isEditMode && currentUserRole === 'admin')) {
            leaderSelectionDiv.style.display = 'block';
            leaderRequiredAsterisk.style.display = 'inline';
        } else {
            leaderSelectionDiv.style.display = 'none';
            leaderRequiredAsterisk.style.display = 'none';
            if (!(isEditMode && currentUserRole === 'admin')) { // Don't clear if admin edit
                document.getElementById('leader_id').value = '';
            }
        }
    }

    if (roleSelect) { // Check if roleSelect exists (it won't if form is disabled for admin edit)
        roleSelect.addEventListener('change', toggleLeaderSelection);
        toggleLeaderSelection();
    } else if (currentUserRole === 'member') { // Handle case where role select is disabled but is member
        leaderSelectionDiv.style.display = 'block';
        leaderRequiredAsterisk.style.display = 'inline';
    }

    // Toggle custom domain input
    function toggleCustomDomain() {
        if (emailDomain.value === '') {
            customDomain.style.display = 'block';
            customDomain.required = true;
            if (customDomain.value === '') {
                customDomain.focus();
            }
        } else {
            customDomain.style.display = 'none';
            customDomain.required = false;
            updateEmail();
        }
    }

    // Update email preview and hidden field
    function updateEmail() {
        const username = emailUsername.value.trim();
        const domain = emailDomain.value === '' ? customDomain.value.trim() : emailDomain.value;

        let fullEmail = '';
        let isValid = true;
        let errorMessage = '';

        if (username && domain) {
            // Validate domain has a dot when using custom domain
            if (emailDomain.value === '' && !domain.includes('.')) {
                isValid = false;
                errorMessage = 'Please enter a valid domain (e.g., example.com)';
            } else {
                fullEmail = `${username}@${domain}`;
            }
            emailPreview.textContent = fullEmail || 'Enter valid email';
        } else if (username) {
            emailPreview.textContent = 'Enter domain';
        } else if (domain) {
            emailPreview.textContent = 'Enter username';
        } else {
            emailPreview.textContent = 'Enter username and select domain';
        }

        // Update error message and styling
        if (errorMessage) {
            if (!customDomain.nextElementSibling || !customDomain.nextElementSibling.classList.contains('invalid-feedback')) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'invalid-feedback d-block';
                errorDiv.textContent = errorMessage;
                customDomain.parentNode.insertBefore(errorDiv, customDomain.nextSibling);
                customDomain.classList.add('is-invalid');
            }
        } else {
            const errorDiv = customDomain.nextElementSibling;
            if (errorDiv && errorDiv.classList.contains('invalid-feedback')) {
                errorDiv.remove();
                customDomain.classList.remove('is-invalid');
            }
        }

        // Update the hidden email field only if valid
        emailHidden.value = isValid ? fullEmail : '';
        
        // Toggle form submission based on validity
        const submitButton = document.querySelector('button[type="submit"]');
        if (submitButton) {
            submitButton.disabled = !isValid || !username || !domain;
        }
    }

    // Event listeners
    emailDomain.addEventListener('change', function() {
        if (this.value === '') {
            customDomain.style.display = 'block';
            customDomain.required = true;
            if (customDomain.value === '') {
                customDomain.focus();
            }
        } else {
            customDomain.style.display = 'none';
            customDomain.required = false;
            updateEmail();
        }
    });

    emailUsername.addEventListener('input', updateEmail);
    customDomain.addEventListener('input', updateEmail);

    // Initialize
    if (emailDomain.value === '' && customDomain.value) {
        customDomain.style.display = 'block';
    }
    updateEmail();

    // Add validation on form submission
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const username = emailUsername.value.trim();
            const domain = emailDomain.value === '' ? customDomain.value.trim() : emailDomain.value;
            
            if (emailDomain.value === '' && domain && !domain.includes('.')) {
                e.preventDefault();
                updateEmail(); // Show error message
                return false;
            }
            return true;
        });
    }
    });
</script>
{% endblock %}