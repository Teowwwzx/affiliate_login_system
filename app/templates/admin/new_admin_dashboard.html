{% extends "new_base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block page_content %}
<!-- Dashboard Widgets Grid -->
<div class="row mt-4">
    <div class="col-xl-6 col-lg-12 mb-4">
        <div class="new-admin-card h-100">
            <div class="card-header">
                System Statistics
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-6 col-sm-6 mb-2">
                        <h6 class="text-muted mb-1">Total Users</h6>
                        <h3 class="fw-bold fs-1">{{ stats.total_users if stats else 'N/A' }}</h3>
                    </div>
                    <div class="col-6 col-sm-6 mb-2">
                        <h6 class="text-muted mb-1">Active Users</h6>
                        <h3 class="fw-bold fs-1">{{ stats.active_users if stats else 'N/A' }}</h3>
                    </div>
                    <div class="col-6 col-sm-6 mb-2">
                        <h6 class="text-muted mb-1">Total Leaders</h6>
                        <h3 class="fw-bold fs-1">{{ stats.count_leaders if stats else 'N/A' }}</h3>
                    </div>
                    <div class="col-6 col-sm-6 mb-2">
                        <h6 class="text-muted mb-1">Members</h6>
                        <h3 class="fw-bold fs-1">{{ stats.count_members_under_leader if stats else 'N/A' }}</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Prize Pools Overview Card -->
    <div class="col-xl-6 col-lg-12 mb-4">
        <div class="new-admin-card h-100">
            <div class="card-header">
                Prize Pool Overview
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                    <span class="amount me-2 display-5 fw-bold">
                        ${{ "%.2f"|format(stats.total_net_profit) if stats and stats.total_net_profit is not none else '0.00' }}
                    </span>
                </div>
                <h6 class="text-muted mb-3">Total Net Profit</h6>
                <div class="row align-items-center">
                    <div class="col-md-5 p-0">
                        <div class="mb-3 mx-auto" style="height: 180px; width: 180px; position: relative;">
                            <canvas id="prizePoolChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="legend">
                            {% for fund_type, fund_data in stats.funds_summary.items() %}

                            <div class="legend-item d-flex justify-content-between align-items-center mb-2">
                                <span>
                                    <span class="legend-color-box me-2" style="background-color: {{ loop.cycle('#4e73df', '#1cc88a', '#36b9cc') }}"></span>
                                    {{ fund_data.display_name }}
                                </span>
                                <span class="fw-semibold">
                                    ${{ "%.2f"|format(fund_data.net_profit) if fund_data.net_profit is not none else '0.00' }}
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Top Leaders Card -->
    <div class="col-xl-5 col-lg-12 mb-4">
        <div class="new-admin-card h-100 d-flex flex-column">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    Top Leaders
                    <small class="text-muted fs-7 ms-1">(Value per Member: ${{ stats.current_value_price if stats and
                        stats.current_value_price is not none else 'N/A' }})</small>
                </span>
            </div>
            <div class="card-body p-0 flex-grow-1" id="salesLeaderboardTop3Container" style="overflow-y: auto;">
                <ul class="list-group list-group-flush" id="salesLeaderboardTop3">
                    <!-- JavaScript will populate this -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Referral Codes Card -->
    <div class="col-xl-7 col-lg-12 mb-4">
        <div class="new-admin-card h-100 d-flex flex-column"> <!-- Ensure card takes full height -->
            <div class="card-header d-flex justify-content-between align-items-center">
                Referral Codes
            </div>
            <!-- Made this div grow and scroll -->
            <div class="card-body p-0 flex-grow-1" style="overflow-y: auto; max-height: 340px;">
                <ul class="list-group list-group-flush referral-code-list-dashboard" id="referralCodeList">
                    {% if referral_codes_users %}
                    {% for user_code_entry_debug in referral_codes_users[:5] %} {# Changed variable name for test #}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong class="code">{{ user_code_entry_debug.personal_referral_code }}</strong>
                            <small class="text-muted d-block">{{ user_code_entry_debug.username }} ({{
                                user_code_entry_debug.email
                                if user_code_entry_debug.email else 'N/A' }})</small>
                        </div>
                        <div>
                            {% if user_code_entry_debug.status %}
                            <span class="status-badge status-active">Active</span>
                            {% else %}
                            <span class="status-badge status-inactive">Inactive</span>
                            {% endif %}
                            <small class="text-muted d-block text-end">{{
                                user_code_entry_debug.created_at.strftime('%Y-%m-%d') if
                                user_code_entry_debug.created_at else 'N/A'
                                }}</small>
                        </div>
                    </li>
                    {% endfor %}
                    {% else %}
                    <li class="list-group-item text-center text-muted">No referral codes found.</li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Leaderboard code remains the same
        const leadersData = {{ stats.leaders_for_sales_calc | tojson | safe if stats and stats.leaders_for_sales_calc else '[]' }};
        let sortAscending = false;
        const valuePerMember = {{ stats.current_value_price if stats and stats.current_value_price is not none else 0 }};
        const sortOrderToggleButton = document.getElementById('sortOrderToggle');

        function calculateAndRenderLeaderboard() {
            const sortedLeaders = [...leadersData].map(leader => {
                const sales = (leader.member_count || 0) * valuePerMember;
                return { ...leader, sales };
            }).sort((a, b) => {
                return sortAscending ? a.sales - b.sales : b.sales - a.sales;
            });
            renderLeaderboard(sortedLeaders.slice(0, 5));
            updateSortButtonText();
        }

        function renderLeaderboard(sortedLeaders) {
            const leaderboardList = document.getElementById('salesLeaderboardTop3');
            if (!leaderboardList) return;
            leaderboardList.innerHTML = '';

            if (sortedLeaders.length === 0) {
                leaderboardList.innerHTML = '<li class="list-group-item text-center text-muted">No leader data available.</li>';
                return;
            }

            const icons = [
                '<i class="bi bi-trophy-fill me-3" style="background-image: var(--rank-color-1); -webkit-background-clip: text; background-clip: text; color: transparent;"></i>',
                '<i class="bi bi-trophy-fill me-3" style="background-image: var(--rank-color-2); -webkit-background-clip: text; background-clip: text; color: transparent;"></i>',
                '<i class="bi bi-trophy-fill me-3" style="background-image: var(--rank-color-3); -webkit-background-clip: text; background-clip: text; color: transparent;"></i>',
                '<i class="bi bi-award-fill me-3" style="background-image: var(--rank-color-4); -webkit-background-clip: text; background-clip: text; color: transparent;"></i>',
                '<i class="bi bi-award-fill me-3" style="background-image: var(--rank-color-5); -webkit-background-clip: text; background-clip: text; color: transparent;"></i>'
            ];

            sortedLeaders.forEach((leader, index) => {
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item d-flex justify-content-between align-items-center';

                const iconHtml = index < icons.length ? icons[index] : 
                    `<span class="leader-rank me-2">${index + 1}</span>`;

                listItem.innerHTML = `
                    <div class="leader-info d-flex align-items-center">
                        ${iconHtml}
                        <div>
                            <strong class="leader-name">${leader.username}</strong>
                            <small class="text-muted d-block">${leader.member_count} members</small>
                        </div>
                    </div>
                    <span class="sales-amount fw-semibold text-success">$${(leader.sales || 0).toFixed(2)}</span>
                `;
                leaderboardList.appendChild(listItem);
            });
        }

        function updateSortButtonText() {
            if (sortOrderToggleButton) {
                sortOrderToggleButton.textContent = sortAscending ? 'Sort: Low to High' : 'Sort: High to Low';
            }
        }

        if (sortOrderToggleButton) {
            sortOrderToggleButton.addEventListener('click', function () {
                sortAscending = !sortAscending;
                calculateAndRenderLeaderboard();
            });
        }

        // Initial render
        calculateAndRenderLeaderboard();

        // Prize Pool Chart
        const prizePoolCtx = document.getElementById('prizePoolChart');
        if (prizePoolCtx) {
            // Get funds data from the template context
            const fundsData = {{ stats.funds_summary | tojson | safe if stats and stats.funds_summary else '{}' }};
            const chartData = {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [],
                    borderWidth: 1
                }]
            };

            // Add each fund type to the chart data
            Object.entries(fundsData).forEach(([fundType, data], index) => {
                chartData.labels.push(data.display_name || fundType);
                chartData.datasets[0].data.push(parseFloat(data.net_profit) || 0);
                
                // Use a color rotation for different fund types
                const colors = [
                    'rgba(78, 115, 223, 0.8)',
                    'rgba(28, 200, 138, 0.8)',
                    'rgba(54, 185, 204, 0.8)',
                    'rgba(246, 194, 62, 0.8)',
                    'rgba(231, 74, 59, 0.8)'
                ];
                chartData.datasets[0].backgroundColor.push(colors[index % colors.length]);
            });

            // Only create chart if we have data
            if (chartData.labels.length > 0) {
                new Chart(prizePoolCtx, {
                    type: 'doughnut',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '65%',
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        return `${label}: $${value.toLocaleString('en-US', { 
                                            minimumFractionDigits: 2,
                                            maximumFractionDigits: 2 
                                        })}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Update legend colors
            document.querySelectorAll('.legend-color-box').forEach((box, index) => {
                if (!box.style.backgroundColor) {
                    const colors = [
                        'rgba(78, 115, 223, 1)',
                        'rgba(28, 200, 138, 1)',
                        'rgba(54, 185, 204, 1)'
                    ];
                    box.style.backgroundColor = colors[index % colors.length];
                }
            });
        }
    });
</script>
{% endblock %}