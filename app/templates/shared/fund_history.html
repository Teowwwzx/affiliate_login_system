{% extends "shared/dashboard_base.html" %}
{% set show_prize_pool = false %}

{% block title %}Fund History - {{ current_year }} {{ month_names[current_month] if current_month else '' }}{% endblock %}

{% block page_content %}
<div class="widget" style="margin-bottom: 30px;">
    <div class="widget-header" style="padding-bottom: 20px;">
        <span class="me-auto">Fund History</span>
        <form method="GET" action="{{ url_for(request.endpoint) }}" id="fundHistoryFilterForm" class="ms-auto">
            <div style="display: flex; align-items: center; gap: 10px;">
                <input type="hidden" name="year" value="{{ current_year }}">
                <div>
                    <label for="month_filter" class="form-label visually-hidden" style="padding-right: 2px;">Month</label>
                    <select name="month" id="month_filter" class="form-select form-select-sm" style="min-width: 50px; padding: 2px; background-color: transparent; color: #A9BCD0; border: 1px solid #415A77;">
                        {% set months_for_current_year = [] %}
                        {% for date_info in available_dates %}
                            {% if date_info.year == current_year and date_info.month not in months_for_current_year %}
                                {% set _ = months_for_current_year.append(date_info.month) %}
                            {% endif %}
                        {% endfor %}
                        
                        {% for month_num in months_for_current_year|sort %}
                        <option value="{{ month_num }}" {% if month_num == current_month %}selected{% endif %}>{{ month_names.get(month_num, 'N/A') }}</option>
                        {% endfor %}
                        
                        {# If current_month is set and not already listed (because it has no data for current_year), add it as an option and select it. #}
                        {% if current_month is not none and current_month not in months_for_current_year %}
                            <option value="{{ current_month }}" selected>{{ month_names.get(current_month, 'N/A') }}</option>
                        {% endif %}
                    </select>
                </div>
            </div>
        </form>
    </div>

    <div class="widget-content">
        {% if fund_type_details and fund_type_details.items %}
        <div class="table-responsive mt-3 mb-3 new-admin-card p-3">
            <table class="table table-striped table-hover align-middle futuristic-table">
                <thead class="table-light">
                    <tr>
                        <th>Fund Type</th>
                        <th class="text-end">Sales ($)</th>
                        <th class="text-end">Payout ($)</th>
                        <th class="text-end">Profit ($)</th>
                        <th>Period</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in fund_type_details.items %}
                    <tr>
                        <td>{{ record.fund_type.replace('_', ' ')|title if record.fund_type else 'N/A' }}</td>
                        <td class="text-end">{{ "%.2f"|format(record.sales if record.sales is not none else 0) }}</td>
                        <td class="text-end">{{ "%.2f"|format(record.payout if record.payout is not none else 0) }}</td>
                        <td class="text-end">{{ "%.2f"|format(record.total_profit if record.total_profit is not none else 0) }}</td>
                        <td>{{ record.snapshot_date.strftime('%b %Y') if record.snapshot_date else 'N/A' }}</td>
                    </tr>
                    {% endfor %}
                    {% if monthly_summary %}
                    <tr class="table-active">
                        <td><strong>Totals</strong></td>
                        <td class="text-end">{{ "%.2f"|format(monthly_summary.sales if monthly_summary.sales is not none else 0) }}</td>
                        <td class="text-end">{{ "%.2f"|format(monthly_summary.payout if monthly_summary.payout is not none else 0) }}</td>
                        <td class="text-end">
                            <div><strong>{{ "%.2f"|format(monthly_summary.total_profit if monthly_summary.total_profit is not none else 0) }}</strong></div>
                            <!-- <div class="fw-bold {{ 'text-success' if (monthly_summary.total_net_profit if monthly_summary.total_net_profit is not none else 0) >= 0 else 'text-danger' }}">
                                {{ "%.2f"|format(monthly_summary.total_net_profit if monthly_summary.total_net_profit is not none else 0) }}
                            </div> -->
                        </td>
                        <td></td> {# Empty cell for Period column in summary row #}
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        {% elif not fund_type_details.items and not monthly_summary %}
        <div class="alert alert-info mt-5 mb-5">
            <i class="fas fa-info-circle me-2"></i> No fund summary details found for {{ month_names[current_month] }}
            {{
            current_year }}.
        </div>
        {% endif %}
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const yearFilter = document.getElementById('year_filter');
            const monthFilter = document.getElementById('month_filter');
            const filterForm = document.getElementById('fundHistoryFilterForm');

            function submitForm() {
                if (filterForm) {
                    filterForm.submit();
                }
            }

            if (yearFilter) {
                yearFilter.addEventListener('change', submitForm);
            }
            if (monthFilter) {
                monthFilter.addEventListener('change', submitForm);
            }
        });
    </script>
    {% endblock %}